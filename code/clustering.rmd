---
title: "Clustering Numerical Data"
author: ""
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
---

Libraries
```{r}
library(tidyverse)
library(ggcorrplot)
library(GGally)
library(naniar)
library(DT)
library(caret)
library(pROC)
```

```{r}
summary(new_diabetic_readmission_data)
```

### Dropping the columns of medicine with low balance in each class <100
```{r}
new_diabetic_readmission_data

## 15 combs: other -> 
## treatment_regimen: 15266(0), Treated (1)

## Remove unbalance categories; if the minimimun category has values <100, the entire medicine is removed.

new_diabetic_readmission_data_reduce_low_cat <- remove_unbalanced_categorical_values(new_diabetic_readmission_data, 100)

## Finding all medicine combinations
combinations <- find_treatment_combination(new_diabetic_readmission_data)
## Regrouping medicine combinations if they are atleast 900> patients with that drug combinations

new_diabetic_readmission_data_reduce_low_cat$med_combs <- recategorize_drug_comb(combinations)

### Treated patients: Return 0 if patients not treated, 1 if not treated. 
new_diabetic_readmission_data_reduce_low_cat$treated <- patients_treated_with_any_drugs(new_diabetic_readmission_data, medicines)

### patients treated with banned drugs (Based on the research)
new_diabetic_readmission_data_reduce_low_cat$treated_banned_drugs <- treated_with_banned(new_diabetic_readmission_data, discontinued_medicines)
```

## Model 2: < 30; >30
```{r}
data <- new_diabetic_readmission_data_reduce_low_cat
data$y <- ifelse(data$readmitted == '<30', 1, ifelse(data$readmitted=='>30', 0, NA))
new_diabetic_readmission_data_reduce_low_cat_mod <- data[!is.na(data$y), ]
```

#### Data Splitting
```{r}
y <- new_diabetic_readmission_data_reduce_low_cat$y
trainIdx <- createDataPartition(y, 0.7)$Resample1
trainData <- new_diabetic_readmission_data_reduce_low_cat[trainIdx, ]
testData <- new_diabetic_readmission_data_reduce_low_cat[-trainIdx, ]

## 2 Model
y <- new_diabetic_readmission_data_reduce_low_cat_mod$y
trainIdx <- createDataPartition(y, 0.7)$Resample1
trainDataMod <- new_diabetic_readmission_data_reduce_low_cat[trainIdx, ]
testDataMod <- new_diabetic_readmission_data_reduce_low_cat[-trainIdx, ]
```
### Logistic Regression Model

```{r}
logit <- glm(y ~ . -encounter_id 
             - patient_nbr - admission_type_id - discharge_disposition_id - readmitted -admission_type_id-treated, data = trainData, family = "binomial", na.action = na.omit)
summary(logit)
mod_logit2 <- glm(y ~ . -encounter_id 
            - patient_nbr - admission_type_id - discharge_disposition_id - readmitted - admission_type_id-treated, data = trainDataMod,  family = "binomial", na.action = na.omit)
summary(mod_logit2)
```

### Accuracy For Logistic Regression
```{r}
confusionMatrix(testData$y, as.factor(ifelse(predict(logit, testData, type="response")> 0.5, 1, 0)))
```

```{r}
confusionMatrix(testDataMod$y, as.factor(ifelse(predict(mod_logit2, 
                                                        testDataMod, type="response")> 0.5, 1, 0)))
```
```{r}
par(pty="s")
roc_lg <- roc(testData$y ~ predict(logit, testData, type="response"), plot = TRUE, print.auc = TRUE, main="ROC curve of logistic regression")
roc_lg2 <- roc(testDataMod$y ~ predict(mod_logit2, testDataMod, type="response"), plot = TRUE, print.auc = TRUE, main="ROC curve of logistic regression")
```



### Medicine Combinations 
```{r}
new_diabetic_readmission_data_reduce_low_cat$med_combs<- as.factor(find_treatment_combination(new_diabetic_readmission_data_reduce_low_cat))
```




