---
title: "Project"
author: ""
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
---

Libraries
```{r}
library(tidyverse)
library(ggcorrplot)
library(GGally)
library(naniar)
library(DT)
```
Data
```{r}
diabetic_readmission_data <- read.csv("../data/diabetic_data_initial.csv")
data_size<- NROW(diabetic_readmission_data)
```

Show the data
```{r}
datatable(t(head((diabetic_readmission_data))))
```

### Data Cleaning

## Missing values: 

```{r}
diabetic_readmission_data <- diabetic_readmission_data %>% mutate(across(where(is.character), ~na_if(., "?")))
gg_miss_var(diabetic_readmission_data[, colSums(is.na(diabetic_readmission_data)) > 0] , show_pct=T) + labs(x ="features", y = "Missing values in the dataset") + theme_bw()
```


## Handling Missing Values: 

- Drop weight, medical_speciality, payer_code; the enitre column.
- Remove the rows of diag_3, diag_2, and diag_1
- Impute by KNN

### Data type-conversion
 This code maps the diagnosis values to the categories provides
```{r}
for (col in c('diag_1', 'diag_2', 'diag_3')) {
  diabetic_readmission_data <- diabetic_readmission_data %>% 
    mutate(new_col = case_when(
      .data[[col]] %in%  c(390:459, 785) ~ 'Circulatory',
      .data[[col]] %in%  c(460:519, 786) ~ 'Respiratory',
      .data[[col]] %in%  c(520:579, 787) ~ 'Digestive',
      .data[[col]] %in%  c(800:999) ~ 'Injury',
      .data[[col]] %in%  c(710:739) ~ 'Musculoskeletal',
      .data[[col]] %in%  c(580:629, 788) ~ 'Genitourinary',
      .data[[col]] %in%  c(1:249, 251:279,680:709, 780:782, 784, 790:799, 782) ~ 'Neoplasms',
       startsWith(.data[[col]], '250' ) ~'Diabetes',
      .default = as.character('Other'))
   ) %>% mutate(!!col := new_col) %>% select(-new_col)
}

diabetic_readmission_data$diag_1 <- as.factor(diabetic_readmission_data$diag_1)
diabetic_readmission_data$diag_2 <- as.factor(diabetic_readmission_data$diag_2)
diabetic_readmission_data$diag_3 <- as.factor(diabetic_readmission_data$diag_3)
```
### Changing categorical data to as factors;
```{r}
diabetic_readmission_data$encounter_id <- as.factor(diabetic_readmission_data$encounter_id)
diabetic_readmission_data$patient_nbr <- as.factor(diabetic_readmission_data$patient_nbr)

diabetic_readmission_data$race <- as.factor(diabetic_readmission_data$race)
diabetic_readmission_data$gender <- as.factor(diabetic_readmission_data$gender)
diabetic_readmission_data$age <- as.factor(diabetic_readmission_data$age)

diabetic_readmission_data$admission_type_id <- as.factor(diabetic_readmission_data$admission_type_id)
diabetic_readmission_data$discharge_disposition_id <- as.factor(diabetic_readmission_data$discharge_disposition_id)
diabetic_readmission_data$admission_source_id <- as.factor(diabetic_readmission_data$admission_source_id)
diabetic_readmission_data$medical_specialty <- as.factor(diabetic_readmission_data$medical_specialty)

for (i in c(23:NCOL(diabetic_readmission_data))) {
  diabetic_readmission_data[, i] <- as.factor(diabetic_readmission_data[, i])
}
```

## Removing dead or hospice patients; remove the repeated patients only (only keep the first encounter)
```{r}
dead_hospice <- c(11,13,14,19,20,21,18,25,26)
diabetic_readmission_data_iid <- diabetic_readmission_data %>%
  group_by(by =patient_nbr) %>%
  arrange(encounter_id) %>%
  slice(1) %>%
  filter(!discharge_disposition_id %in% dead_hospice)
```

## Convert the data into admitted or not admitted category

--> <30, >30 : 1
--> NO: 0

```{r}
table(diabetic_readmission_data_iid$readmitted)
```

## Univariate distributions
### Distributions for each numerical feature in the dataset
```{r}
data<- diabetic_readmission_data[, unlist(lapply(diabetic_readmission_data, is.factor))]
col_names <- names(data)
nums_subplots <- 8
for (col_s in seq(1, NCOL(data), nums_subplots )) {
  long_data <- pivot_longer(data[, seq(col_s:min(col_s+8, 40))], col_names[seq(col_s:min(col_s+8, 40))],
               names_to="features",
               values_to="values")
  g <- ggplot(long_data, aes(x=values, fill=features)) 
  g + geom_histogram(stat='count') + 
    facet_wrap(~ features, scales = "free") + 
    ggtitle("Categorical Features Distribution") + coord_flip() + 
    scale_y_continuous(breaks = scales::pretty_breaks(n=5)) +
    theme(legend.position = "top", strip.text.x = element_blank(),
                        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  print(g)
}
```

```{r}
data<- diabetic_readmission_data[, unlist(lapply(diabetic_readmission_data, is.numeric))]
col_names <- names(data)
nums_subplots <- 8
for (col_s in seq(1, NCOL(data), nums_subplots )) {
  long_data <- pivot_longer(data[, seq(col_s:min(col_s+8, 40))], col_names[seq(col_s:min(col_s+8, 40))],
               names_to="features",
               values_to="values")
  g <- ggplot(long_data, aes(x=values, fill=features)) 
  g + geom_histogram(stat='count') + 
    facet_wrap(~ features, scales = "free") + 
    ggtitle("Categorical Features Distribution") + coord_flip() + 
    scale_y_continuous(breaks = scales::pretty_breaks(n=5)) +
    theme(legend.position = "top", strip.text.x = element_blank(),
                        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  print(g)
}

```



### Correlation for each class:

```{r}
col_names <- c("num_lab_procedures", "num_procedures", "time_in_hospital", "num_medications", "number_outpatient", "number_emergency", "number_inpatient", "number_diagnoses")
#View(col_names)

##class 0: 
n_ <- diabetic_readmission_data %>% filter(y == 0)
ggcorrplot(cor(n_[col_names]))
```

```{r}
## Class 1
n_ <- diabetic_readmission_data %>% filter(y == 1)
ggcorrplot(cor(n_[col_names]))
```

```{r}
ggpairs(diabetic_readmission_data, columns=col_names, aes(color = y, alpha = 0.5))
```

<<<<<<< Updated upstream
## Categorical Variables 
```{r}
str(diabetic_readmission_data)
```

```{r}
medicine1 <- c("metformin","repaglinide","nateglinide","chlorpropamide","glimepiride","acetohexamide")
medicine2 <- c("glipizide","glyburide","tolbutamide","pioglitazone","rosiglitazone","acarbose")
medicine3 <- c("miglitol","troglitazone","tolazamide","examide","citoglipton","insulin")
medicine4 <- c("glyburide.metformin","glipizide.metformin","glimepiride.pioglitazone","metformin.rosiglitazone","metformin.pioglitazone")
ggpairs(diabetic_readmission_data, columns=medicine1, aes(color = y, alpha = 0.5))
ggpairs(diabetic_readmission_data, columns=medicine2, aes(color = y, alpha = 0.5))
ggpairs(diabetic_readmission_data, columns=medicine3, aes(color = y, alpha = 0.5))
ggpairs(diabetic_readmission_data, columns=medicine4, aes(color = y, alpha = 0.5))

```
##Variable Transformations
#Removing weight, payer code, and medical speciality features because they are missing a lot of data
```{r}
#Removing weight, payer code, and medical specialty features
new_diabetic_readmission_data <- subset(diabetic_readmission_data, select = -c(weight, payer_code, medical_specialty))
#new_diabetic_readmission_data #verifying those columns are gone
```
#code checking/removing missing values from diagnoses 3. I commented it out for now because I would like to discuss this with the group. 
```{r}
#checking out many missing values are in diag_3 column 
sum(grepl("\\?", diabetic_readmission_data$diag_3))
sum(grepl("\\?", diabetic_readmission_data$diag_1))
sum(grepl("\\?", diabetic_readmission_data$diag_2))
length(diabetic_readmission_data$diag_3)

#1419 rows are missing from diag_3
#356 rows are missing from diag_2
#20 rows are missing from diag 1



#To remove the entire column: 
#new_diabetic_readmission_data <- subset(diabetic_readmission_data, select = -c(diag_3))

#To remove the rows:
#new_diabetic_readmission_data <- new_diabetic_readmission_data[!grepl("\\?", new_diabetic_readmission_data$diag_3), ]



=======
## Age, race
```{r}
## overall age
ggplot(diabetic_readmission_data, aes(x=age, fill=y)) + geom_bar() +coord_flip()

## age
ggplot(diabetic_readmission_data, aes(x=race, fill=y)) + geom_bar() +coord_flip()
>>>>>>> Stashed changes

```
#log transformation of numerical variables 
#Purpose: normalizing dataset. reduce knewness of a measurement variable.
```{r}
#install.packages("moments")
#library(moments)
num_data <- select_if(new_diabetic_readmission_data, is.numeric)
apply(num_data, 2, skewness)

<<<<<<< Updated upstream
diabetic_readmission_transformations <- new_diabetic_readmission_data %>%
  mutate(log_time_in_hospital = log(time_in_hospital),
         log_num_lab_procedures = log(num_lab_procedures),
         log_num_procedures = log(num_procedures + 1),
         log_num_medications = log(num_medications),
         log_num_outpatient = log(number_outpatient + 1),
         log_num_emergency = log(number_emergency + 1),
         log_num_inpatient = log(number_inpatient + 1),
         log_num_diagnoses = log(number_diagnoses))
diabetic_readmission_transformations
         
```
 
=======
```{r}
## overall diag1
table(diabetic_readmission_data$diag_1)
```
>>>>>>> Stashed changes

References: 

1. http://www.sthda.com/english/wiki/ggcorrplot-visualization-of-a-correlation-matrix-using-ggplot2